# Kickstart config file generated by Spacewalk Config Management
# Profile Label : Default-7
# Date Created  : 2018-02-21 11:42:51.004669

install
text
url --url http://pinkus.nmc-m.dtag.de/ks/dist/org/2/Oracle7u6
lang en_US
keyboard de
zerombr
clearpart --all
bootloader --location mbr
timezone --utc Europe/Berlin
auth --enableshadow --passalgo=sha256
rootpw --iscrypted $5$PGFPF.kI4k6P9Muq$Sz1ixUvzwlXDrwX42vSsNsKkSXHpoLbigw9GiYRWKK0
selinux --disabled
reboot
firewall --disabled
skipx
%include /tmp/network.ks
repo --name=ol7-spacewalk26-client --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7-spacewalk26-client/Oracle7u6
repo --name=ol7_x86_64_optional_latest --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7_x86_64_optional_latest/Oracle7u6
repo --name=epel_el7_x86_64 --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/epel_el7_x86_64/Oracle7u6
repo --name=ol7_its-infrastructure --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7_its-infrastructure/Oracle7u6
repo --name=ol7_x86_64_softwarecollections12 --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7_x86_64_softwarecollections12/Oracle7u6
repo --name=ol7_x86_64_addons --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7_x86_64_addons/Oracle7u6
repo --name=ol7_x86_64_ksplice --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7_x86_64_ksplice/Oracle7u6
repo --name=ol7_x86_64_uekr3 --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/ol7_x86_64_uekr3/Oracle7u6
repo --name=emc_networker-ol7 --baseurl=http://pinkus.nmc-m.dtag.de/ks/dist/child/emc_networker-ol7/Oracle7u6
part /boot --fstype=ext4 --size=512 --ondisk=sda
part pv.01 --size=1024 --grow --ondisk=sda
volgroup vg_root pv.01
logvol / --vgname=vg_root --name=lv_root --size=4096 --fstype=ext4
logvol swap --vgname=vg_root --name=lv_swap --size=1024 --fstype=swap
logvol /var/log --vgname=vg_root --name=lv_tmp --size=1024 --fstype=ext4
logvol /var/log --vgname=vg_root --name=lv_var_log --size=2048 --fstype=ext4

%packages 
@ Base
osad
perl
wget
rhn-setup
rhn-check
rhn-client-tools
%end

%pre

wget "http://pinkus.nmc-m.dtag.de/cblr/svc/op/trig/mode/pre/profile/Default-7:2:OSPS-ITS" -O /dev/null



echo "Saving RHN keys..." > /dev/ttyS0
SYSTEM_ID=/etc/sysconfig/rhn/systemid
rhn_keys_found=no

mkdir -p /tmp/rhn

drives=$(list-harddrives | awk '{print $1}')
for disk in $drives; do
    DISKS="$DISKS $(fdisk -l /dev/$disk | grep -v "swap\|LVM\|Extended" | awk '/^\/dev/{print $1}')"
done

# Try to find the keys on ordinary partitions
for disk in $DISKS; do
    name=test-$(basename $disk)
    mkdir -p /tmp/$name
    mount $disk /tmp/$name
    [ $? -eq 0 ] || continue # Skip to the next partition if the mount fails

    # Copy current RHN host keys out to be reused
    if [ -f /tmp/${name}$SYSTEM_ID ]; then
        cp -a /tmp/${name}$SYSTEM_ID /tmp/rhn
        rhn_keys_found="yes"
        umount /tmp/$name
        break
    fi
    umount /tmp/$name
    rm -r /tmp/$name
done

# Try LVM if that didn't work
if [ "$rhn_keys_found" = "no" ]; then
    lvm lvmdiskscan
    vgs=$(lvm vgs | tail -n +2 | awk '{ print $1 }')
    for vg in $vgs; do
        # Activate any VG we found
        lvm vgchange -ay $vg
    done
    
    lvs=$(lvm lvs | tail -n +2 | awk '{ print "/dev/" $2 "/" $1 }')
    for lv in $lvs; do
        tmpdir=$(mktemp -d findkeys.XXXXXX)
        mkdir -p /tmp/${tmpdir}
        mount $lv /tmp/${tmpdir} || continue # Skip to next volume if this fails

        # Let's see if the keys are in there
        if [ -f /tmp/${tmpdir}$SYSTEM_ID ]; then
            cp -a /tmp/${tmpdir}$SYSTEM_ID /tmp/rhn/
            rhn_keys_found="yes"
            umount /tmp/${tmpdir}
            break # We're done!
        fi
        umount /tmp/${tmpdir}
        rm -r /tmp/${tmpdir}
    done
    
    # And clean up..
    for vg in $vgs; do
        lvm vgchange -an $vg
    done
fi


%end

%pre --log /tmp/ks-pre.log.1
#
# User defined pre script
#
FILE=network_default
# Netzwerk Konfigurationsdaten einlesen
cd /tmp
wget http://pinkus.nmc-m.dtag.de/pub/kickstart/config/$FILE

for x in `cat /proc/cmdline`; do
        case $x in hostname*)
	        eval $x
		grep $hostname /tmp/$FILE > /tmp/network.ks
                ;;
	esac;
done

%end

%post --nochroot
mkdir /mnt/sysimage/tmp/ks-tree-copy
if [ -d /oldtmp/ks-tree-shadow ]; then
cp -fa /oldtmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
elif [ -d /tmp/ks-tree-shadow ]; then
cp -fa /tmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
fi
cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :

cp `awk '{ if ($1 ~ /%include/) {print $2}}' /tmp/ks.cfg` /tmp/ks.cfg /mnt/sysimage/root
%end

%post --nochroot --interpreter /usr/bin/python
try:
    import xmlrpclib
    import shutil
    import sys
    import os.path
    old_system_id = "/tmp/rhn/systemid"
    new_system_id = "/mnt/sysimage/root/systemid.old"
    tmp_key = "/mnt/sysimage/tmp/key"

    new_keys = "2-d10893ff696fc03ef1d0bd786e091769,2-Register7_only"
    for key in new_keys.split(','):
        if key.startswith('re-'):
            sys.exit(0)
    if os.path.exists(old_system_id):
        client =  xmlrpclib.Server("http://pinkus.nmc-m.dtag.de/rpc/api")
        key = client.system.obtain_reactivation_key(open(old_system_id).read())
        if os.path.exists(tmp_key):
            f = open(tmp_key, "r+")
            contents = f.read()
            if contents and not contents[-1] == ',':
                f.write(',')
        else:
            f = open(tmp_key, "w")
        f.write(key)
        f.close()
        shutil.copy(old_system_id, new_system_id)
except:
    # xml rpc due to  a old/bad system id
    # we don't care about those
    # we'll register those as new.
    pass


%end

%post --log /root/ks-rhn-post.log
# --Begin Spacewalk command section--
cat > /tmp/gpg-key-1 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.14 (GNU/Linux)

mQENBFKNo7MBCAC0jNhQOzGg9a1kL85l9xbu71pWwWoLgPnSRO4CgvKgwlCvsXTN
ZkZtsjOIf2VwBpp7QRMtlJyJYfNPhUP9Esi+ucHHvNkyr/Yuw/vD/jqVmiIZWXWx
IMcrZq1Qu+UZoYWQLUoc3ZibOtMY3fD1rI0ty3abMZpv6t6jdQo2zqca2Tu65TQo
TF7QaxMuODhQlBy7O1qZppDUJBiPCvPuNnu2o9a0cT+/d6vystffwHOcCdGeGJjA
ETcR25xmVkeTvMLzPh5CTKVePyFuE1Y1f04jvcT5oI8d/o/srm8Xb1XInsi9LP4z
lAl+GvgOaQDSjwR2Ut7S39FCK/pqpiZO4kvTABEBAAG0T1JQTSBBZG1pbiAoQ3Jl
YXRpbmcgYW5kIHNpZ25pbmcgcnBtcyBmb3Igc2F0ZWxsaXRlKSA8cmhuc2F0YWRt
aW5Abm1jLW0uZHRhZy5kZT6JATgEEwECACIFAlKNo7MCGwMGCwkIBwMCBhUIAgkK
CwQWAgMBAh4BAheAAAoJECJ/UGfILMSPLCwH+wYKF/X3QwryoMibrHRz0njbWX6a
q1olVLybMb7n/LqXlVlyLiZ74jW7kDtSylBzSbuIamChIoPxuqswq0eFj1RXLBQI
G/1dQzlGdhKC0Gzbcf8rbJr44foT0N2d8zEQl6qhYLpnRw/RI47qKQmQn4g2s0mV
bgQ20hwl0aCVNIynFVVpx5CG3dNj7uia09nUj3LxrjiiU8QatNWoIT1odSanp2y1
+FcVVPJfD6jJA9Ptc/++5+ru96i/n3EJpQVu2WnrEcpXgbgE/JSFP+EYJV/TnJgd
tMdl5HfKEVI5VTIoic7hijiemgCCum1UTuN4qJ4o0QId/LSF07XqsUbIkgG5AQ0E
Uo2jswEIALB8o8iKJmyAWW7UA1/dLVJ2pJRi62EHd+CrmZG+W0YHqHC7iXDwOuHI
L+bf012/UpFZiLCBJmWx1rVTAJFaRqtJBfIxfTWu3jshviU3maPv9ke/2KP9a4hH
9vGksXLfqhV1Jwp+jnb7KdLFw68B8SQuE+QVEC2Fo3pL1ry/Xfejow5NLPsd/f71
L8sMgAk0LMffS0VhHw7lt/5P+0iR7Xhep4RS7IY2KHosTnqpcyZk0UGUlfqKmT23
22Hho7z5CVSWSRC5Ln0+BMpLqAwLWqS8mcHDpT1q1iueRky44KQtPIcsxl26cVVQ
VFGO5R5kLUDu0GiPZB3ilLNCPNVtW2sAEQEAAYkBHwQYAQIACQUCUo2jswIbDAAK
CRAif1BnyCzEj4JJCACnkXSARPpTaKca8uPdvdqCa91IAhvFFSADox3SAtksNVg6
FsFBVkGFizD8YjGfpMM2+Pw9E7/iyoh9w9HPx1oHE8Hc+Zs0UVC6Un3i+rJ7Iymc
InkXWpeu3pWMVUaorbKSBd81s3IgCdgVUYLFqSNFoB7IzY6JmYX/DSekrCdQfGa0
1NyrCza/nFiWP+c6tn639WFMeHPJeZMtCXUQvLDO+pjCHE2P3VvAZ6NPZo/qR7XO
w39p3w7WhT3KTjP0I0xGYqaockPUqhbes+7ikN5DmFpod5lvx+Qh82M92hCaxAeI
hnyt6PxzcfKPA424rfuTm4BS1DvzqpS5vlssDsG6
=litJ
-----END PGP PUBLIC KEY BLOCK-----
EOF
# gpg-key1
rpm --import /tmp/gpg-key-1
cat > /tmp/gpg-key-2 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.5 (GNU/Linux)

mQENBEwtJWoBCACpiY2rGA6T0ceBi92X88/QclytVBjtDRohOVzs3pmIPh3ULqsW
G323nmyKbKQBBSjh9OnuO9Y09VG8mzr/w9YV0Ix4cI9/HDTERZ2+TR5u+VNn5J5h
yvwQSN/FEK6oH2+mz7O0yUNleN7UltR4MOEkHIoAhIvv+1AQQKN3OM8oalz+3gv/
zz9rAoQczQzT7QWOtBrsRMZgBrKXY/TpJrpVSO3Hx8CnbhKGtLxCCrxZ5v7hh1ht
3CRAr2+h5bDA9KP6vBZWKEs7NgcvtZFDY6EJc7AoApr3phX9hHE2+snTxe82DkFT
uA69C8wLyjPCoSy+tcaCqJKOZelNy9RN/WKRABEBAAG0RE9yYWNsZSBPU1MgZ3Jv
dXAgKE9wZW4gU291cmNlIFNvZnR3YXJlIGdyb3VwKSA8YnVpbGRAb3NzLm9yYWNs
ZS5jb20+iQE8BBMBAgAmAhsDBgsJCAcDAgQVAggDBBYCAwECHgECF4AFAlNhkUEF
CSaOl9cACgkQcvl7dOxVHwNHFQf9G2ZI5ZH8T1VASvQteTyUR7uNgqXEbJhi9zZO
7EO26+wzkj9EGLmH1COdUApZ1cINsYfGGgUJT5mfcRV3yYZbwc4AZJbJe0z7C5Yu
ZLs5W0ryV4bzIqcWnVphIAOwmxMxIVGz8Cr1Dsyyal7ORgYzdfOppYetwtZ+J+Wn
/oVgFkh9v19l/CltBkRh2SqgUZYfCoELo7hUzLNh7cw2av8rcSUKSH3ra9MvpYfS
ANCnouzbgKix1gD6niT3pm1s5II3VuQ2vEcJunnoRFci9FzLXelTuL00MvuxERr7
Fsqm1/D2JfKDbE09qy5bLWrWaTM6zOFQKN7F2edY2uaukLT6/w==
=Djed
-----END PGP PUBLIC KEY BLOCK-----

EOF
# gpg-key2
rpm --import /tmp/gpg-key-2
cat > /tmp/gpg-key-3 <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.11 (GNU/Linux)

mQINBFKuaIQBEAC1UphXwMqCAarPUH/ZsOFslabeTVO2pDk5YnO96f+rgZB7xArB
OSeQk7B90iqSJ85/c72OAn4OXYvT63gfCeXpJs5M7emXkPsNQWWSju99lW+AqSNm
jYWhmRlLRGl0OO7gIwj776dIXvcMNFlzSPj00N2xAqjMbjlnV2n2abAE5gq6VpqP
vFXVyfrVa/ualogDVmf6h2t4Rdpifq8qTHsHFU3xpCz+T6/dGWKGQ42ZQfTaLnDM
jToAsmY0AyevkIbX6iZVtzGvanYpPcWW4X0RDPcpqfFNZk643xI4lsZ+Y2Er9Yu5
S/8x0ly+tmmIokaE0wwbdUu740YTZjCesroYWiRg5zuQ2xfKxJoV5E+Eh+tYwGDJ
n6HfWhRgnudRRwvuJ45ztYVtKulKw8QQpd2STWrcQQDJaRWmnMooX/PATTjCBExB
9dkz38Druvk7IkHMtsIqlkAOQMdsX1d3Tov6BE2XDjIG0zFxLduJGbVwc/6rIc95
T055j36Ez0HrjxdpTGOOHxRqMK5m9flFbaxxtDnS7w77WqzW7HjFrD0VeTx2vnjj
GqchHEQpfDpFOzb8LTFhgYidyRNUflQY35WLOzLNV+pV3eQ3Jg11UFwelSNLqfQf
uFRGc+zcwkNjHh5yPvm9odR1BIfqJ6sKGPGbtPNXo7ERMRypWyRz0zi0twARAQAB
tChGZWRvcmEgRVBFTCAoNykgPGVwZWxAZmVkb3JhcHJvamVjdC5vcmc+iQI4BBMB
AgAiBQJSrmiEAhsPBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRBqL66iNSxk
5cfGD/4spqpsTjtDM7qpytKLHKruZtvuWiqt5RfvT9ww9GUUFMZ4ZZGX4nUXg49q
ixDLayWR8ddG/s5kyOi3C0uX/6inzaYyRg+Bh70brqKUK14F1BrrPi29eaKfG+Gu
MFtXdBG2a7OtPmw3yuKmq9Epv6B0mP6E5KSdvSRSqJWtGcA6wRS/wDzXJENHp5re
9Ism3CYydpy0GLRA5wo4fPB5uLdUhLEUDvh2KK//fMjja3o0L+SNz8N0aDZyn5Ax
CU9RB3EHcTecFgoy5umRj99BZrebR1NO+4gBrivIfdvD4fJNfNBHXwhSH9ACGCNv
HnXVjHQF9iHWApKkRIeh8Fr2n5dtfJEF7SEX8GbX7FbsWo29kXMrVgNqHNyDnfAB
VoPubgQdtJZJkVZAkaHrMu8AytwT62Q4eNqmJI1aWbZQNI5jWYqc6RKuCK6/F99q
thFT9gJO17+yRuL6Uv2/vgzVR1RGdwVLKwlUjGPAjYflpCQwWMAASxiv9uPyYPHc
ErSrbRG0wjIfAR3vus1OSOx3xZHZpXFfmQTsDP7zVROLzV98R3JwFAxJ4/xqeON4
vCPFU6OsT3lWQ8w7il5ohY95wmujfr6lk89kEzJdOTzcn7DBbUru33CQMGKZ3Evt
RjsC7FDbL017qxS+ZVA/HGkyfiu4cpgV8VUnbql5eAZ+1Ll6Dw==
=hdPa
-----END PGP PUBLIC KEY BLOCK-----

EOF
# gpg-key3
rpm --import /tmp/gpg-key-3
cat > /tmp/ssl-key-1 <<'EOF'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 9788759855226581775 (0x87d8a939aa62730f)
    Signature Algorithm: sha1WithRSAEncryption
        Issuer: C=DE, ST=BW, L=Stuttgart, O=NSO, OU=OSPS-ITS, CN=crusty.nmc-m.dtag.de
        Validity
            Not Before: Nov 24 09:41:34 2015 GMT
            Not After : Nov 18 09:41:34 2036 GMT
        Subject: C=DE, ST=BW, L=Stuttgart, O=NSO, OU=OSPS-ITS, CN=crusty.nmc-m.dtag.de
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:c6:e2:b4:0d:9f:c5:82:f6:09:b8:99:0b:56:5b:
                    a6:75:2b:07:b0:2d:41:8c:fe:cd:8c:2d:8d:c3:e5:
                    05:62:a8:68:da:f6:eb:f3:6a:8a:fa:03:51:ec:f1:
                    d2:59:89:c7:00:82:aa:76:65:37:2a:11:e9:a0:77:
                    b2:8b:23:47:40:a1:dc:c8:31:50:9b:ef:5a:bb:56:
                    52:90:25:08:a4:40:1c:ca:5f:48:52:57:4d:5e:5e:
                    69:73:08:64:7a:d6:d4:fa:49:21:d6:33:90:90:06:
                    cc:6d:7d:0e:26:4b:99:da:d4:26:51:91:a6:bd:91:
                    52:27:e1:ee:93:b4:48:76:4c:8d:3b:3e:98:e7:0e:
                    15:9f:ee:a4:e5:fa:fe:54:2d:a2:fa:a5:56:73:72:
                    c8:b3:5c:4e:a3:b4:c5:0a:c2:f0:10:a1:bf:48:4c:
                    b7:87:7e:3f:06:ad:84:f3:45:73:b2:9a:d6:27:ee:
                    47:2d:bb:7f:d0:70:47:40:3c:81:53:0e:87:a2:43:
                    19:e5:d8:b6:ed:3b:33:d0:98:2d:a6:1e:0e:b5:9d:
                    81:55:e2:c0:35:51:d7:11:05:9d:40:b4:1f:83:91:
                    7f:4f:9f:e5:a0:cc:48:a9:6e:e7:c6:f8:be:00:e8:
                    bd:b3:54:e8:84:70:44:4c:90:a5:0b:08:79:0d:ac:
                    2e:7f
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:TRUE
            X509v3 Key Usage: 
                Digital Signature, Key Encipherment, Certificate Sign
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            Netscape Comment: 
                RHN SSL Tool Generated Certificate
            X509v3 Subject Key Identifier: 
                B5:C2:CC:BD:5B:A6:54:7D:A6:AB:80:C0:5B:29:0C:94:67:44:AE:8C
            X509v3 Authority Key Identifier: 
                keyid:B5:C2:CC:BD:5B:A6:54:7D:A6:AB:80:C0:5B:29:0C:94:67:44:AE:8C
                DirName:/C=DE/ST=BW/L=Stuttgart/O=NSO/OU=OSPS-ITS/CN=crusty.nmc-m.dtag.de
                serial:87:D8:A9:39:AA:62:73:0F

    Signature Algorithm: sha1WithRSAEncryption
         39:79:d4:a3:1b:7e:fc:b6:b6:b4:84:68:23:53:5e:de:c4:c0:
         bb:e5:1f:9f:5e:17:15:19:8f:6e:96:3e:f7:72:ed:fb:ff:93:
         f2:39:58:2d:04:54:ca:44:ef:7f:93:81:e6:01:de:25:22:a7:
         8f:39:d6:41:19:32:a0:3d:14:b4:bc:17:40:9b:3b:6a:a3:f5:
         5d:a6:1f:fb:3d:1e:b7:9d:28:64:2b:52:12:ba:19:48:db:30:
         69:25:1e:b9:ce:ca:71:8a:f2:55:6c:0b:2a:ae:73:81:34:25:
         08:1e:5a:92:81:40:bf:84:88:05:9d:4a:25:48:28:29:3b:b2:
         02:e4:23:98:f7:7c:62:aa:04:56:54:d7:60:9c:c0:31:53:25:
         14:3f:86:66:63:be:f6:a8:ed:d1:bb:1d:15:7b:e9:e3:bf:09:
         87:1e:51:3f:62:52:aa:34:e4:a8:37:b5:d6:52:3f:73:0f:15:
         df:5b:88:b7:91:04:2a:69:96:51:8c:e1:1c:d3:02:3c:13:91:
         c9:1b:2f:ab:42:82:fc:7e:e2:a8:c8:37:12:89:61:d4:33:f2:
         8e:d0:85:f6:22:9c:a7:cf:18:49:8d:3c:9e:c1:7a:03:30:ab:
         f0:ae:00:5c:18:e6:14:e8:0b:0f:92:f3:67:2f:57:81:83:be:
         29:d6:5f:06
-----BEGIN CERTIFICATE-----
MIIElDCCA3ygAwIBAgIJAIfYqTmqYnMPMA0GCSqGSIb3DQEBBQUAMG4xCzAJBgNV
BAYTAkRFMQswCQYDVQQIEwJCVzESMBAGA1UEBxMJU3R1dHRnYXJ0MQwwCgYDVQQK
EwNOU08xETAPBgNVBAsTCE9TUFMtSVRTMR0wGwYDVQQDExRjcnVzdHkubm1jLW0u
ZHRhZy5kZTAeFw0xNTExMjQwOTQxMzRaFw0zNjExMTgwOTQxMzRaMG4xCzAJBgNV
BAYTAkRFMQswCQYDVQQIEwJCVzESMBAGA1UEBxMJU3R1dHRnYXJ0MQwwCgYDVQQK
EwNOU08xETAPBgNVBAsTCE9TUFMtSVRTMR0wGwYDVQQDExRjcnVzdHkubm1jLW0u
ZHRhZy5kZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMbitA2fxYL2
CbiZC1ZbpnUrB7AtQYz+zYwtjcPlBWKoaNr26/NqivoDUezx0lmJxwCCqnZlNyoR
6aB3sosjR0Ch3MgxUJvvWrtWUpAlCKRAHMpfSFJXTV5eaXMIZHrW1PpJIdYzkJAG
zG19DiZLmdrUJlGRpr2RUifh7pO0SHZMjTs+mOcOFZ/upOX6/lQtovqlVnNyyLNc
TqO0xQrC8BChv0hMt4d+PwathPNFc7Ka1ifuRy27f9BwR0A8gVMOh6JDGeXYtu07
M9CYLaYeDrWdgVXiwDVR1xEFnUC0H4ORf0+f5aDMSKlu58b4vgDovbNU6IRwREyQ
pQsIeQ2sLn8CAwEAAaOCATMwggEvMAwGA1UdEwQFMAMBAf8wCwYDVR0PBAQDAgKk
MB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAxBglghkgBhvhCAQ0EJBYi
UkhOIFNTTCBUb29sIEdlbmVyYXRlZCBDZXJ0aWZpY2F0ZTAdBgNVHQ4EFgQUtcLM
vVumVH2mq4DAWykMlGdErowwgaAGA1UdIwSBmDCBlYAUtcLMvVumVH2mq4DAWykM
lGdEroyhcqRwMG4xCzAJBgNVBAYTAkRFMQswCQYDVQQIEwJCVzESMBAGA1UEBxMJ
U3R1dHRnYXJ0MQwwCgYDVQQKEwNOU08xETAPBgNVBAsTCE9TUFMtSVRTMR0wGwYD
VQQDExRjcnVzdHkubm1jLW0uZHRhZy5kZYIJAIfYqTmqYnMPMA0GCSqGSIb3DQEB
BQUAA4IBAQA5edSjG378tra0hGgjU17exMC75R+fXhcVGY9ulj73cu37/5PyOVgt
BFTKRO9/k4HmAd4lIqePOdZBGTKgPRS0vBdAmztqo/Vdph/7PR63nShkK1ISuhlI
2zBpJR65zspxivJVbAsqrnOBNCUIHlqSgUC/hIgFnUolSCgpO7IC5COY93xiqgRW
VNdgnMAxUyUUP4ZmY772qO3Rux0Ve+njvwmHHlE/YlKqNOSoN7XWUj9zDxXfW4i3
kQQqaZZRjOEc0wI8E5HJGy+rQoL8fuKoyDcSiWHUM/KO0IX2IpynzxhJjTyewXoD
MKvwrgBcGOYU6AsPkvNnL1eBg74p1l8G
-----END CERTIFICATE-----

EOF
# ssl-key1
cat /tmp/ssl-key-* > /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT
perl -pe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/up2date

mkdir -p /tmp/rhn_rpms/optional
cd /tmp/rhn_rpms/optional 
wget -P /tmp/rhn_rpms/optional http://pinkus.nmc-m.dtag.de/download/package/095b6d632258331cdbe39b72f3e394b2be5bad43/0/2/88754/libxml2-2.9.1-6.0.1.el7_2.3.x86_64.rpm http://pinkus.nmc-m.dtag.de/download/package/645af1645d7f0c6d39f214cd4add5e17eb59d4a6/0/2/171872/rhnlib-2.6.3-1.el7.noarch.rpm http://pinkus.nmc-m.dtag.de/download/package/4dbc6203cc9a55693ea74bdb3b42b887a0248bd7/0/2/88775/libxml2-python-2.9.1-6.0.1.el7_2.3.x86_64.rpm http://pinkus.nmc-m.dtag.de/download/package/3bd6bf28f0e27bd84b42fb9d2889447fe34b89ea/0/2/218682/pyOpenSSL-0.13.1-4.el7.x86_64.rpm 
rpm -Uvh --replacepkgs --replacefiles /tmp/rhn_rpms/optional/pyOpenSSL* /tmp/rhn_rpms/optional/rhnlib* /tmp/rhn_rpms/optional/libxml2-python* /tmp/rhn_rpms/optional/libxml2* 
perl -npe 's|^(\s*(noSSLS\|s)erverURL\s*=\s*[^:]+://)[^/]*/|${1}pinkus.nmc-m.dtag.de/|' -i /etc/sysconfig/rhn/up2date
[ -r /etc/yum.conf ] && perl -npe 's/debuglevel=2/debuglevel=5/' -i /etc/yum.conf
[ -r /etc/sysconfig/rhn/up2date ] && perl -npe 's/debug=0/debug=1/' -i /etc/sysconfig/rhn/up2date
mkdir -p /etc/sysconfig/rhn/allowed-actions/script
touch /etc/sysconfig/rhn/allowed-actions/script/run
mkdir -p /etc/sysconfig/rhn/allowed-actions/configfiles
touch /etc/sysconfig/rhn/allowed-actions/configfiles/all

# now copy from the ks-tree we saved in the non-chroot checkout
cp -fav /tmp/ks-tree-copy/* / 2>/dev/null
rm -Rf /tmp/ks-tree-copy
# --End Spacewalk command section--

# begin cobbler snippet

# Start post_install_network_config generated code
# End post_install_network_config generated code

# set default MOTD
echo "Kickstarted on $(date +'%Y-%m-%d')" >> /etc/motd

# begin Red Hat management server registration
mkdir -p /usr/share/rhn/
wget http://pinkus.nmc-m.dtag.de/pub/RHN-ORG-TRUSTED-SSL-CERT -O /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT   
perl -Xnpe 's/RHNS-CA-CERT/RHN-ORG-TRUSTED-SSL-CERT/g' -i /etc/sysconfig/rhn/*  
if [ -f /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release ]; then
    rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
fi
key=2-d10893ff696fc03ef1d0bd786e091769,2-Register7_only
if [ -f /tmp/key ]; then
    key=`cat /tmp/key`,$key
fi

rhnreg_ks --serverUrl=https://pinkus.nmc-m.dtag.de/XMLRPC --sslCACert=/usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT --activationkey=$key
# end Red Hat management server registration

# end cobbler snippet

rhn_check
%end


%post --log /root/ks-post.log.1
#
# User defined post script
#
# Default Gateway setzen
sed -i '/^GATEWAY/d' /etc/sysconfig/network
echo "any net default gw 153.17.118.1" >>/etc/sysconfig/static-routes
#

# GATEWAY Eintraege aus den ifcfg-ethX files entfernen
sed -i '/^GATEWAY/d' /etc/sysconfig/network-scripts/ifcfg-eth*
#

# NM_CONTROLLED=yes auf no setzen
sed -i 's/^NM_CONTROLLED="yes"/NM_CONTROLLED="no"/' /etc/sysconfig/network-scripts/ifcfg-eth*
#

# Konfigdateien aus dem Configchannel abholen
rhncfg-client get
#

# Configure postfix:
postconf -e 'mydomain = nmc-m.dtag.de'
postconf -e 'myhostname ='$(hostname)
postconf -e 'myorigin = $mydomain'
postconf -e 'mynetworks = 127.0.0.0/8'
postconf -e 'inet_interfaces = localhost'
postconf -e 'smtp_host_lookup = dns,native'
postconf -e 'relayhost = mailserver.nmc-m.dtag.de'
postconf -e 'masquerade_domains = nmc-m.dtag.de'
systemctl enable postfix
systemctl restart postfix
#

# Unerwuenschte Dienste ausschalten
systemctl disable netfs
systemctl disable chronyd
#
# Notwendige Dienste einschalten
systemctl enable osad
systemctl enable ntpd

#SSH-KEYS erzeugen
ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N ''

# OS updaten
yum -y update
#

# Statusmail verschicken
echo 'Installation ist beendet.'|mailx -s "$(hostname) wurde installiert" rhnsatadmin@nmc-m.dtag.de
#

## ENDE ##
%end

%post --log /root/ks-post.log.2
# Install & Register ALM, TOS, SSM-IP -ku- 20181022
# ALM Install & Base Configuration Snippet for IP2BN Clients
curl -m 3 -q -k https://10.90.122.83 >/dev/null 2>&1
if [[ $? -eq 0 ]]
then
mkdir -p /etc/alm && chmod 700 /etc/alm && cd /etc/alm
curl -k https://10.90.122.83/alm/download/alm_collector_unix.tar.gz > alm_collector_unix.tar.gz && gunzip alm_collector_unix.tar.gz
tar -xf alm_collector_unix.tar && rm -f alm_collector_unix.tar
wget http://pinkus.nmc-m.dtag.de/pub/alm/user.conf
/etc/alm/alm_start.sh cron
/etc/alm/alm_start.sh
mkdir -p /root/alm && cd /root/alm
wget http://pinkus.nmc-m.dtag.de/pub/alm/alm_script_updater.sh && chmod 744 alm_script_updater.sh
# Download and Generate random crontab entry 
wget http://pinkus.nmc-m.dtag.de/pub/alm/alm_script_updater_crontab.sh && chmod 744 alm_script_updater_crontab.sh
/root/alm/alm_script_updater_crontab.sh
else
echo "ALM ist fuer $(hostname) nicht erreichbar und konnte nicht installiert werden." | mailx -s "ALM Kickstart Install error" rhnsat-admin@nmc-m.dtag.de
fi
 
cd /root
curl -k https://10.90.122.83/patch/tos.tar > tos.tar
tar -xvf tos.tar
cd /root/tos
sed -i"" 's/STOKEN=""/STOKEN="nsoos02-8007470aa66bd9c4fa60da9f"/g' config.sh
sed -i"" 's/MNAME="my-new-machine"/MNAME="`hostname`"/g' config.sh
/root/tos/taste_os.sh -m reg -c /root/tos/config.sh -p /root/tos
/root/tos/taste_os.sh  -c /root/tos/config.sh -p /root/tos
cat <(crontab -l) <(echo "13 7 * * * /root/tos/taste_os.sh -c /root/tos/config.sh -p /root/tos >/tmp/tos.log 2>&1" ) | crontab -
 
yum -y install glibc.i686 
yum -y install libgcc.i686 
yum -y install libstdc++.x86_64 
yum -y install motif.x86_64 
yum -y install mesa-libGLw.x86_64 
yum -y install m4.x86_64 
mkdir /tmp/ovo
cd /tmp/ovo
wget http://pinkus.nmc-m.dtag.de/pub/kickstart/ovo/OMAgt12.06_Linux2.6_X64.tar
tar xvf OMAgt12.06_Linux2.6_X64.tar
cd /tmp/ovo/Linux2.6_X64
./oasetup.sh -install -management_server oml.nmc-m.dtag.de
./oasetup.sh -configure -management_server oml.nmc-m.dtag.de -certificate_server oml.nmc-m.dtag.de
cd /tmp && rm -rf /tmp/ovo
 
%end

%post


# Start koan environment setup
echo "export COBBLER_SERVER=pinkus.nmc-m.dtag.de" > /etc/profile.d/cobbler.sh
echo "setenv COBBLER_SERVER pinkus.nmc-m.dtag.de" > /etc/profile.d/cobbler.csh
# End koan environment setup



wget "http://pinkus.nmc-m.dtag.de/cblr/svc/op/ks/profile/Default-7:2:OSPS-ITS" -O /root/cobbler.ks
wget "http://pinkus.nmc-m.dtag.de/cblr/svc/op/trig/mode/post/profile/Default-7:2:OSPS-ITS" -O /dev/null
%end
